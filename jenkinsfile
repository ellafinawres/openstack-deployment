pipeline {
    agent any

    environment {
        SSH_KEY = '/var/jenkins_home/.ssh/id_rsa'
        HOST = '192.168.1.19'
        ANSIBLE_INVENTORY = '/etc/ansible/inventory.yml'
        ANSIBLE_PLAYBOOK = '/etc/ansible/site.yml'
        VAULT_PASSWORD_FILE = '/etc/ansible/.vault_pass.txt'
    }

    stages {
        stage('Keystone Deployment') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} nawresellafi@${HOST} \\
                "ansible-playbook -i ${ANSIBLE_INVENTORY} ${ANSIBLE_PLAYBOOK} --tags keystone --vault-password-file ${VAULT_PASSWORD_FILE}"
                """
            }
        }

        stage('Glance Deployment') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} nawresellafi@${HOST} \\
                "ansible-playbook -i ${ANSIBLE_INVENTORY} ${ANSIBLE_PLAYBOOK} --tags glance --vault-password-file ${VAULT_PASSWORD_FILE}"
                """
            }
        }
    }

    post {
        success {
            echo "Déploiement terminé avec succès"
        }
        failure {
            echo "Échec du déploiement"
        }
    }
}
