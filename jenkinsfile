pipeline {
    agent any

    environment {
        SSH_KEY = '/var/jenkins_home/.ssh/id_rsa'
        HOST = '192.168.1.15'
        ANSIBLE_INVENTORY = '/etc/ansible/inventory.yml'
        ANSIBLE_PLAYBOOK = '/etc/ansible/site.yml'
    }

    stages {
        stage('Test SSH') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} nawresellafi@${HOST} 'echo Connexion réussie'
                """
            }
        }

        stage('Test Ansible') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} nawresellafi@${HOST} \
                "ansible-playbook -i ${ANSIBLE_INVENTORY} ${ANSIBLE_PLAYBOOK} --check"
                """
            }
        }

        stage('Déploiement') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} nawresellafi@${HOST} \
                "ansible-playbook -i ${ANSIBLE_INVENTORY} ${ANSIBLE_PLAYBOOK}"
                """
            }
        }
    }

    post {
        success {
            echo "Déploiement terminé avec succès"
        }
        failure {
            echo "Échec du déploiement"
        }
    }
}
